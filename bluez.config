#!/bin/bash
set -e

# Source debconf library.
. /usr/share/debconf/confmodule

db_get bluez/users
if [ -n "$( echo $RET | grep \${ )" ]; then
	db_set bluez/users ""
	db_fset bluez/users seen false
fi

db_metaget bluez/users users
users="$(getent passwd | awk -F: '{if ($3 >= 1000 && $3 < 60000) print $1}' | sort | tr '\n' ',' | sed 's@,@, @g;s@, $@@g')"
bt=$(getent group bluetooth | cut -d: -f4 | sed -e 's@,@ @g')

# Don't show users already in bluetooth
for u in $bt; do
	users=$(echo $users | sed "s@$u, @@g;s@, $u\$@@g;s@^$u\$@@g");
done

db_subst bluez/users users "$users"

db_input high bluez/users || true
db_go

db_get bluez/users
users=$(echo $RET | sed -e 's@,@@g')

# Add selected users
for u in $users; do
	adduser --quiet $u bluetooth
done
